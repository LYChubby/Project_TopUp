<main class="game-sec container mt-4">
  <div class="product-container">
    <section class="product-info">
      <section class="product-detail">
        <div class="product-detail-banner-container" style="width: 431px; height: 162px">
          <img src="images/logo-mobile-legends.jpg" alt="" class="product-detail-banner" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px" />
        </div>
        <div class="product-detail-description">
          <h2 class="product-detail-name">Mobile Legend</h2>
          <div class="product-detail-tag-container">
            <div class="product-detail-icon-tag">
              <p>Pembayaran yang Aman</p>
            </div>
            <div class="product-detail-icon-tag">
              <p>Butuh Bantuan?</p>
            </div>
          </div>
        </div>
        <div class="preview-transaksi"></div>
      </section>
    </section>
    <section class="product-form-purchase">
      <form class="product-form-container" action="#" name="gameUser">
        <section class="form-section-container">
          <div class="form-section-container-topbar">
            <p class="step-number">1</p>
            <h2 class="title-bar">Masukan ID Game</h2>
          </div>
          <div class="form-section-container-main server">
            <div class="form-section">
              <label for="game-id">Mobile Legend ID</label>
              <input class="form-section-input" id="game-id" type="text" placeholder="Masukkan ID Game" autocomplete="off" style="width: 100%" />
            </div>
            <div class="form-section">
              <label for="game-server">Server</label>
              <input class="form-section-input" id="game-server" type="text" placeholder="Masukkan Server Game" autocomplete="off" style="width: 100%" />
            </div>
          </div>
          <p>Untuk menemukan ID & Server akun Anda, klik avatar Anda di pojok kiri atas layar dan buka tab Info Umum. Contoh: 12345678 (9864), maka ID adalah 12345678 dan Server adalah 9864</p>
        </section>
        <section class="form-section-container">
          <div class="form-section-container-topbar">
            <p class="step-number">2</p>
            <h2 class="title-bar">Pilih Nominal TopUp</h2>
            <button type="button" class="btn btn-primary ms-auto me-3 btnAdmin" style="margin-left: auto" onclick="openAddModal()">Tambah Data</button>
          </div>
          <div class="form-section-container-main">
            <p>Special Items</p>
            <div class="form-section-card" id="specialItemsContainer">
              <!-- Special Items Cards will be dynamically rendered here -->
            </div>
          </div>
          <div class="form-section-container-main">
            <p>Top Up Instant</p>
            <div class="form-section-card" id="instantTopUpContainer">
              <!-- Instant Top-Up Cards will be dynamically rendered here -->
            </div>
          </div>
        </section>

        <section class="form-section-container">
          <div class="form-section-container-topbar">
            <p class="step-number">3</p>
            <h2 class="title-bar">Masukkan Jumlah Pembelian</h2>
          </div>
          <div class="form-section-container-main">
            <div class="quantity-container">
              <input type="number" id="input-quantity" class="quantity-input" value="1" min="1" />
              <button type="button" id="plus-btn" class="btn btn-secondary">+</button>
              <button type="button" id="minus-btn" class="btn btn-secondary">-</button>
            </div>
          </div>
        </section>

        <section class="form-section-container">
          <div class="form-section-container-topbar">
            <p class="step-number">4</p>
            <h2 class="title-bar">Metode Pembayaran</h2>
          </div>
          <div class="form-section-container-main">
            <div class="form-section">
              <div class="form-section-card">
                <div class="card-container">
                  <div class="card-items">
                    <img class="logo-items-pay" src="/images/gopaylogo.png" alt="" />
                    <div class="pay-bill" id="pay-bill">Rp 0</div>
                  </div>
                </div>
                <div class="card-container">
                  <div class="card-items">
                    <img class="logo-items-pay" src="/images/shopeepaylogo.png" alt="" />
                    <div class="pay-bill" id="pay-bill">Rp 0</div>
                  </div>
                </div>
                <div class="card-container">
                  <div class="card-items">
                    <img class="logo-items-pay" src="/images/danalogo.png" alt="" />
                    <div class="pay-bill" id="pay-bill">Rp 0</div>
                  </div>
                </div>
                <div class="card-container">
                  <div class="card-items">
                    <img class="logo-items-pay" src="/images/danalogo.png" alt="" />
                    <div class="pay-bill" id="pay-bill">Rp 0</div>
                  </div>
                </div>
                <div class="card-container">
                  <div class="card-items">
                    <img class="logo-items-pay" src="/images/danalogo.png" alt="" />
                    <div class="pay-bill" id="pay-bill">Rp 0</div>
                  </div>
                </div>
                <div class="card-container">
                  <div class="card-items">
                    <img class="logo-items-pay" src="/images/danalogo.png" alt="" />
                    <div class="pay-bill" id="pay-bill">Rp 0</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
        <section class="form-section-container">
          <div class="form-section-container-topbar">
            <p class="step-number">5</p>
            <h2 class="title-bar">Kontak Anda</h2>
          </div>
          <div class="form-section-container-main">
            <div class="form-section">
              <label for="game-id">Opsional: Jika anda ingin mendapatkan bukti pembayaran atas pembelian anda, harap mengisi alamat emailnya</label>
              <input class="form-section-input" id="game-id" type="text" placeholder="Alamat E-mail" autocomplete="off" style="width: 100%" />
            </div>
          </div>
        </section>
      </form>
    </section>
  </div>
</main>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // Fungsi untuk menyembunyikan tombol admin
  const hideAdminButtons = () => {
    const addButtons = document.querySelectorAll(".btnAdmin");
    addButtons.forEach((button) => {
      button.style.display = "none";
    });
  };

  document.addEventListener("DOMContentLoaded", function () {
    const username = localStorage.getItem("username");
    if (!username) {
      console.error("No username found in localStorage. Please log in.");
    } else {
      console.log("Username fetched from localStorage:", username);
    }

    loadItems();

    if (username !== "admin") {
      console.log("Hiding admin buttons for non-admin user");
      hideAdminButtons();
    } else {
      console.log("Admin user detected, buttons should be visible");
    }
  });

  $(document).ready(function () {
    console.log("DOM telah selesai dimuat");
  });

  // Fungsi loadItems untuk mengambil data item
  function loadItems() {
    $.getJSON("/api/mobile-legend", function (items) {
      renderItems(items);

      const username = localStorage.getItem("username");
      if (username !== "admin") {
        console.log("Hiding admin buttons after rendering for non-admin user");
        hideAdminButtons();
      } else {
        console.log("Admin buttons should remain visible after rendering");
      }
    }).fail(function () {
      alert("Gagal mengambil data");
    });
  }

  // Fungsi untuk merender item
  function renderItems(items) {
    const specialItemsContainer = $("#specialItemsContainer");
    const instantTopUpContainer = $("#instantTopUpContainer");

    specialItemsContainer.empty();
    instantTopUpContainer.empty();

    items.forEach((item) => {
      const card = `
        <div class="card-container" id="item-${item.id}">
          <div class="card-item">
            <div class="points">${item.name}</div>
            <div class="items-price">Rp ${item.price.toLocaleString("id-ID")}</div>
            <div class="d-flex justify-content-around mt-2">
              <button class="btn btn-sm btn-success btnAdmin" style="margin-right: 30px;" onclick="editItem(${item.id})">Edit</button>
              <button class="btn btn-sm btn-danger btnAdmin" onclick="deleteItem(${item.id})">Delete</button>
            </div>
          </div>
          <div class="logo-container">
            <img class="logo-items" src="${item.image_url}" alt="Item Image" />
          </div>
        </div>
      `;
      if (item.type === "special") {
        specialItemsContainer.append(card);
      } else {
        instantTopUpContainer.append(card);
      }
    });
    addCardClickListeners(items);
  }

  let selectedItem = null; // Untuk menyimpan item yang dipilih

  // Fungsi untuk menambahkan event listener pada kartu item
  function addCardClickListeners(items) {
    items.forEach((item) => {
      const cardElement = document.querySelector(`#item-${item.id} .card-item`);
      const quantityInput = document.getElementById("input-quantity"); // Ambil input jumlah

      if (cardElement) {
        cardElement.addEventListener("click", () => {
          selectedItem = item; // Menyimpan item yang dipilih
          updatePayBill(item.price); // Update harga berdasarkan item yang dipilih

          // Reset input jumlah ke 1 saat memilih item baru
          quantityInput.value = 1;
        });
      }
    });
  }

  // Fungsi untuk memperbarui harga pembayaran
  function updatePayBill(amount) {
    const formatCurrency = (number) => {
      return "Rp " + number.toLocaleString("id-ID"); // Format mata uang IDR
    };

    const payBills = document.querySelectorAll("#pay-bill");
    payBills.forEach((payBill) => {
      payBill.textContent = formatCurrency(amount); // Menampilkan harga item
    });
  }

  // Fungsi untuk menghitung total pembayaran berdasarkan jumlah yang dipilih
  function updateTotal() {
    if (!selectedItem) {
      Swal.fire({
        icon: "error",
        title: "Oops...",
        text: "Pilih Item Terlebih Dahulu",
      });
      return;
    }

    const quantity = parseInt(document.getElementById("input-quantity").value, 10); // Ambil jumlah dari input
    const totalAmount = selectedItem.price * quantity; // Hitung total berdasarkan harga dan jumlah
    updatePayBill(totalAmount); // Perbarui total pembayaran
  }

  // Event listener untuk tombol plus dan minus
  document.getElementById("plus-btn").addEventListener("click", () => {
    const quantityInput = document.getElementById("input-quantity");
    let quantity = parseInt(quantityInput.value, 10);
    quantityInput.value = quantity + 1; // Tambah 1 ke jumlah
    updateTotal(); // Update total harga setelah jumlah berubah
  });

  document.getElementById("minus-btn").addEventListener("click", () => {
    const quantityInput = document.getElementById("input-quantity");
    let quantity = parseInt(quantityInput.value, 10);

    if (quantity > 1) {
      quantityInput.value = quantity - 1; // Kurangi 1 dari jumlah (minimal 1)
      updateTotal(); // Update total harga setelah jumlah berubah
    }
  });

  // Event listener untuk input jumlah (untuk mengupdate harga jika jumlah diubah secara manual)
  document.getElementById("input-quantity").addEventListener("input", updateTotal);

  // Edit dan hapus item
  function editItem(id) {
    $.getJSON(`/api/mobile-legend/data/${id}`, function (item) {
      Swal.fire({
        title: "Edit Item",
        html: `
          <form id="itemForm">
            <input type="hidden" id="itemId" value="${item.id}" />
            <div class="mb-3">
              <label for="itemName" class="form-label">Nama Item</label>
              <input type="text" id="itemName" class="form-control" value="${item.name}" required />
            </div>
            <div class="mb-3">
              <label for="itemPrice" class="form-label">Harga</label>
              <input type="number" id="itemPrice" class="form-control" value="${item.price}" required />
            </div>
            <div class="mb-3">
              <label for="itemType" class="form-label">Tipe Item</label>
              <select id="itemType" class="form-select" required>
                <option value="special" ${item.type === "special" ? "selected" : ""}>Special Items</option>
                <option value="instant" ${item.type === "instant" ? "selected" : ""}>Top-Up Instant</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="itemImage" class="form-label">URL Gambar</label>
              <input type="text" id="itemImage" class="form-control" value="${item.image_url}" required />
            </div>
          </form>
        `,
        showCancelButton: true,
        confirmButtonText: "Simpan",
        preConfirm: () => {
          return {
            id: document.getElementById("itemId").value,
            name: document.getElementById("itemName").value,
            price: parseInt(document.getElementById("itemPrice").value, 10),
            type: document.getElementById("itemType").value,
            image_url: document.getElementById("itemImage").value,
          };
        },
      }).then((result) => {
        if (result.isConfirmed) {
          const data = result.value;
          $.ajax({
            url: `/api/mobile-legend/update/${data.id}`,
            method: "PUT",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function () {
              loadItems();
            },
            error: function () {
              Swal.fire({
                icon: "error",
                title: "Oops...",
                text: "Gagal Menyimpan Data",
              });
            },
          });
        }
      });
    }).fail(function () {
      Swal.fire({
        icon: "error",
        title: "Oops...",
        text: "Gagal Mengambil Data Item",
      });
    });
  }

  function deleteItem(id) {
    if (confirm("Apakah Anda yakin ingin menghapus item ini?")) {
      $.ajax({
        url: `/api/mobile-legend/delete/${id}`,
        method: "DELETE",
        success: function () {
          loadItems();
        },
        error: function () {
          Swal.fire({
            icon: "error",
            title: "Oops...",
            text: "Gagal Menghapus Data",
          });
        },
      });
    }
  }

  function openAddModal() {
    Swal.fire({
      title: "Tambah Item Baru",
      html: `
        <form id="itemForm">
          <div class="mb-3">
            <label for="itemName" class="form-label">Nama Item</label>
            <input type="text" id="itemName" class="form-control" required />
          </div>
          <div class="mb-3">
            <label for="itemPrice" class="form-label">Harga</label>
            <input type="number" id="itemPrice" class="form-control" required />
          </div>
          <div class="mb-3">
            <label for="itemType" class="form-label">Tipe Item</label>
            <select id="itemType" class="form-select" required>
              <option value="special">Special Items</option>
              <option value="instant">Top-Up Instant</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="itemImage" class="form-label">URL Gambar</label>
            <input type="text" id="itemImage" class="form-control" required />
          </div>
        </form>
      `,
      showCancelButton: true,
      confirmButtonText: "Simpan",
      preConfirm: () => {
        return {
          name: document.getElementById("itemName").value,
          price: parseInt(document.getElementById("itemPrice").value, 10),
          type: document.getElementById("itemType").value,
          image_url: document.getElementById("itemImage").value,
        };
      },
    }).then((result) => {
      if (result.isConfirmed) {
        const data = result.value;
        $.ajax({
          url: "/api/mobile-legend/tambah",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify(data),
          success: function () {
            loadItems();
          },
          error: function () {
            Swal.fire({
              icon: "error",
              title: "Oops...",
              text: "Gagal Menyimpan Data",
            });
          },
        });
      }
    });
  }
</script>
